---
title: "fis_prep_watson"
author: "Serena"
date: "5/9/2020"
output: html_document
---

# New Global Fisheries Catch Data - Watson data
(script derived from: Download:globalprep/prs_fish/v2020/data_download.Rmd)
Wrangle: ohiprep_v2020/globalprep/fis/v2019/fishing_pressure_layers.Rmd)
# Summary

The commercial fishing layers are created from spatialized catch (by gear??) data provided by Watson (2019)

This script prepares and formats the IMAS Global Fisheries Catch raw data into intermediate data by combining Industrial and Non Industrial catch (Catch_XXXX_XXXX) rds files with geospatial information (sheet name Cells in Codes.xlsx), taxon information (sheet name Taxa in Codes.xlsx), gear (sheet name Gear in Codes.xlsx), and country information (sheet name Country in Codes.xlsx), as well as a single file with all years.

# Data Source

**Reference**: Watson, R. A. and Tidd, A. 2019. Mapping nearly a century and a half of global marine fishing: 1869â€“2017. Marine Policy, 93, pp. 171-177. [(Paper URL)](https://doi.org/10.1016/j.marpol.2018.04.023)

**Downloaded**: September 5, 2020  from [IMAS portal](http://data.imas.utas.edu.au/portal/search?uuid=ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0) - click on download tab, step 3

**Description**:  Global fisheries landings data per cell separated by Industrial versus Non-Industrial catch, IUU, and discards.

**Native data resolution**:   

**Time range**: 1950 - 2015 (?halpern says 2017, but these data are not available yet on the website)

**Format**:  CSV format

**Additional Information**: [Metadata](http://metadata.imas.utas.edu.au/geonetwork/srv/eng/metadata.show), [Supplementary Material](https://ars.els-cdn.com/content/image/1-s2.0-S0308597X18300605-mmc1.docx)
***

* Industrial Catch (1950 - 2019) - reported, iuu, and discard catch data for each cell location and unique identifier
* Non-Industrial Catch (1950 - 2015) - reported, iuu, and discard catch data for each cell location and unique identifier
* Master Index File (Index.csv) - information associated with the unique identifiers. This is split into two files, "IndexInd" (industrial) and "IndexNInd" (non-industrial).
* DATA CODE DEFINITIONS (gear/taxa/country codes and cell lat/lon references)

**Data download**
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(sf)
library(raster)       #Main raster library with nearly all functions used in this analysis
library(rgdal)        #Spatial library - most functions used from rgdal are for vectors (shapefiles)
library(dplyr)        #NOT spatial - this is a data wrangling library
library(ggplot2)
library(here)
library(tidyverse)
library(ncdf4)

library(RColorBrewer)
library(readxl)
#install.packages("DT")
library(DT)


dir_w<-file.path("C:/Users/Acer/Documents/big/fis/watson")
dir_big<-file.path("C:/Users/Acer/Documents/big")
```




##Read in Spatial cells, Taxa reference, Country reference, and a single 5-year Catch dataset. 
 How to download the data code definitions. 

For this, it is saved as an .xlsx file (Codes.xlsx). This file has 4 sheets in it which contain meta data that explain columns in the Index files, and one sheet with is "Spatial Cells Reference - contains geospatial information associated wtih the Industrial Catch data". 
To download this data, go to the IMAS website: http://data.imas.utas.edu.au/portal/search?uuid=ff1274e1-c0ab-411b-a8a2-5a12eb27f2c0 and download it manually.

This .xlsx file contains these sheets:

* Spatial Cells Reference (Cells) - contains geospatial information associated wtih the Industrial Catch data
* Gear Reference (Gear) - contains information regarding how different fishing gear is classified in the index datasets.
* Taxa Reference (Taxa) - contains information regarding how different taxa is classified in the index datasets.
* Country Reference (Country) - contains informations regarding how different countries are labeled in the index datasets. 

## Load Files 

I need to create (wrangle) a new combination of the index file to have "ID", "years","CountryName","TaxonName","CommonName","IndReported","IndIUU","IndDiscards","NIndReported","NIndIUU",and "NIndDiscards" columns

```{r}
###Exploring Watson Fisheries Data
dir_w<-file.path("C:/Users/Acer/Documents/big/fis/watson")#percorso da aprire da pc ufficio
indexInd<-read.csv(file.path(dir_w,"IndexInd.csv"))
indexNInd<-read.csv(file.path(dir_w,"IndexNInd.csv"))

taxa <- read_excel(file.path(dir_w, "Codes.xlsx"), sheet = "Taxa")
country <- read_excel(file.path(dir_w, "Codes.xlsx"), sheet = "Country")
gear <- read_excel(file.path(dir_w, "Codes.xlsx"), sheet = "Gear") %>%
  dplyr::select(FGearCode, FleetGearName) %>%
  unique() ## Need to include the gear in this because we will use this for softbottom habitat pressure
# Spatial cells reference
spatialCells <- read_excel(file.path(dir_w, "Codes.xlsx"), sheet = "Cell")
DT::datatable(head(spatialCells))


#first I work with the global file and then I will crop the file to the Atl region (include also MEd for further valuation)
head(indexNInd)
head(indexInd)
master<-indexInd %>% 
  dplyr::full_join(indexNInd, by=c("ID", "IYear","CNumber","Taxonkey","Gear", "FGearCode","NumCells")) %>% 
  dplyr::left_join(country, by=c("CNumber"="Country")) %>% 
  dplyr::left_join(taxa, by=c("Taxonkey"="TaxonKey")) %>% 
  dplyr::left_join(gear, by=c("FGearCode")) %>% 
  dplyr::select(ID, Year=IYear, CountryName="FAO name",CountryCode=CNumber,TaxonName,CommonName,IndReported=Reported.x,IndIUU=IUUTotal.x,IndDiscards=Discards.x,NIndReported=Reported.y,NIndIUU=IUUTotal.y,NIndDiscards=Discards.y, FleetGearName)

head(master) 
sum(is.na(master))
master[is.na(master)]<-0 #replace the NA value with 0


##Spatial cells reference
spatialCells<-read_excel(file.path(dir_w, "Codes.xlsx"),sheet="Cell")
head(spatialCells)

a<-master %>% 
  filter(Year==1953)
```

Test to see whether the values in the Master file are the same as in the catch
```{r}
##Look at single catch file
data<-readRDS(file.path(dir_w,"raw/CatchInd1950_1954.rds"))
DT::datatable(head(data))

mex_abalone<-data %>% 
  dplyr::filter(ID==2739) %>% 
  dplyr::mutate(tot_Reported=sum(Reported),tot_IUU=sum(IUU),tot_Discards=sum(Discards))

master_check<-master %>% 
  dplyr::filter(ID==2739)

```


#Methods

##Wrangle

Tidy Fisheries Files:
  1. Combine the Master Index and Spatial Cells with the CatchInd and CatchNInd files.
  2. Save each year of data as separate file into the intermediate files folder INT  "prep/fis/INT/annual_catch"

  **Function for combining & saving files**: Create function to read in each file name, combine with Index and Cells data frame, and save each year of catch data into separate file in dir_w


```{r tidy, eval=FALSE}
here()
setwd("C:/Users/Acer/Documents/big/fis/watson")
combine_fis <- function(x) {
  #x <- file.path(dir_w, "/raw/CatchNInd2010_2014.rds")
  
  ## Read in the catch data
  ## Create a total Landings column
  ## Join with master and spatial cells file
  df <- readRDS(x) %>%
    dplyr::mutate(Landings = Reported+IUU) %>% 
    dplyr::left_join(master, by = "ID") %>% 
    dplyr::left_join(spatialCells, by = "Cell")
 
  
  ## Save each individual year as a single file
  five_years <- sort(unique(df$Year)) 
  
  for(yr in five_years){
    print(yr) # will show you your progress
    #yr = 2014
    single_yr_df <- df %>%
      filter(Year == yr)
    
    ## Save files with prefix CatchInd or CatchNInd
    ## Remove the suffix starting with '_' to get CatchInd or CatchNInd
    ind_Nind <- basename(x) %>% 
      tools::file_path_sans_ext() %>% 
      str_remove("d.*") # remove everything after the first underscore
    
    write_rds(single_yr_df, paste0(dir_w,"/int/annual_catch/", ind_Nind, "d_", yr, ".rds"))
    
  }
  
}

dir_raw<-file.path("C:/Users/Acer/Documents/big/fis/watson/raw")#percorso da aprire da pc 
combine_fis(file.path(dir_raw,"CatchInd1955_1959.rds")) #check to see if function writes to mazu
                                                                                                          z#ma non interessa che lo faccia in questo momento??

```



**Industrial Catch Data**
  
  Create list of industrial catch file names and apply the `combine_fis` function to save each individual 5-year interval catch data.

```{r, eval=FALSE}
ind_files <- dir(file.path(dir_w,"/int/annual_catch/"), pattern ="CatchInd", full.names=TRUE)
## Wrangle and Save Each Year of Data Separately
indCatch <- map_df(ind_files, combine_fis)
#check to see if function worked properly
df <- readRDS(file.path(dir_w,"int/annual_catch/CatchInd_1953.rds"))
```



**Non-industrial Catch Data**

Create list of non-industrial catch file names and apply the `combine_fis` function to save each individual 5-year interval catch data. Then, create a single file that has all years of data.

```{r, eval=FALSE}
nind_files <- dir(file.path(dir_w,"/int"), pattern ="CatchNInd", full.names=TRUE)
## Wrangle and Save Each Year of Data Separately
nindCatch <- map_df(nind_files, combine_fis)
#check to see if function worked properly
df <- readRDS(file.path(dir_w,"int/annual_catch/CatchNInd_1950.rds"))
```





## Create Annual Catch Rasters

We want a landings raster and a discards raster for Industrial (commericial) and Non-Industrial (artisanal) data per year. 

Note: Annual catch per cell contains values in units of kg per km^2^. Since values in `Reported`, `Discards`, `Landings`, and `IUU` are in tonnes, they must be first converted to kg then divided by the `Area` column.

1. Setup 
```{r annRasters, eval=FALSE}
library(tidyverse)
library(parallel)
library(foreach)
library(doParallel)
library(raster)
library(rasterVis)
#install.packages("seaaroundus")
#library(seaaroundus)
library(RColorBrewer)
library(cowplot)
library(stringr)

library(colorspace)
library(sp)
registerDoParallel(5) # registering cores for parallel processing
## color palette
cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme
mytheme=rasterTheme(region=cols)
## Set template ocean raster and mollweide projection CRS
ocean <- raster::raster(file.path(dir_big, '/spatial_ohi_supplement/ocean.tif'))
mollCRS=crs('+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs')
options(scipen=999)
```

2. First get the template raster with a resolution of 0.5 degree cells, from the cells data.

The values of these cells are the Cell ID numbers.

```{r, eval=FALSE}
#create a raster of Cell numbers
## This Codes.xlsx was downloaded from the same place as the raw Watson data.
cells <- read_excel(file.path(dir_w, "Codes.xlsx"), sheet = "Cell") %>%
  dplyr::rename(x = LonCentre,  y = LatCentre, z = Cell) %>% #I renamed these xyz to use in the rasterFromXYZ() function below
  dplyr::select(x,y,z)
#turn the lat/long points into a raster
cells_raster <- rasterFromXYZ(cells)
crs(cells_raster) <- "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0" 
crs(cells_raster)
#check out the cells raster to make sure it looks good
plot(cells_raster)
```

3. Create commercial and artisanal rasters

* comm_landings_XXXX.tif
* comm_discards_XXXX.tif
* artisanal_landings_XXXX.tif
* artisanal_discards_XXXX.tif

Catch data is in tonnes, so need to convert to kg then divide by `OceanAreasqkm` (km^2^) to get catch per area. Since `Cell` is the identifier for a specific 30-min spatial cell, we want to add up total landings and total discards grouped by `Cell`.

Note: Subset for data 2003 and onwards since NPP data starts at 2003. Since we will be taking 5-year averages, we will need years 1999-2003 to get the average value for year 2003.


```{r, eval=FALSE}
## Specify years of data, file locations, raster output location
years = c(1999:2015)
rastFolder <- paste0(dir_w,"/int/")
annual_files <- list.files(paste0(rastFolder, "annual_catch"), full.names=TRUE)
## Specify a list of arguments - commercial or artisanal - for reading in data and saving raster file name
raw_suffx <- list(catchind = "CatchInd", catchnind = "CatchNInd")
rast_prefx <- list(comm = "comm", artisanal = "artisanal")
## Function for totalling landings/discards and saves raster files 
catch2raster <- function(raw_suffx,rast_prefx){
  
foreach(yr = years) %dopar% { 
  yr = 1952
  ## find file path of the respective year of data
  yr <- as.character(yr)
  ## Select the respective year of industrial catch data
  dataname <- str_subset(annual_files, paste0(raw_suffx,"*.",yr))
  ## read in raw data
  raw_data <- readRDS(dataname[1])

  ## Total Landings per Cell
  landings <- raw_data %>%
    dplyr::mutate(Landings_CR = (Landings * 1000)/OceanAreasqkm) %>% # convert to catch rate (kg/km^2)
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch = sum(Landings_CR, na.rm=TRUE)) %>% # usually no NAs, but just in case
    dplyr::ungroup() %>%
    data.frame()
 
  #length(unique(raw_data$Cell))
   
#test what is occurring with cells in v4.0
#landings_test <- landings %>%
#  dplyr::arrange(Cell) %>%
#  dplyr::mutate(lag = lag(Cell)) %>%
#  dplyr::mutate(difference = Cell - lag)
  ## Total Discards per Cell
  discards <- raw_data %>%
    dplyr::mutate(Discards_CR = (Discards * 1000)/OceanAreasqkm) %>% 
    dplyr::group_by(Cell) %>%
    dplyr::summarise(cell_catch = sum(Discards_CR)) %>% 
    dplyr::ungroup()
  
  ## Rasterize Catch: swapping template cell values with those in dataframe
 raster::subs(cells_raster, landings, by = "Cell", which = "cell_catch", subsWithNA=TRUE, filename = paste0(rastFolder, rast_prefx, '_landings/annual_catch_', yr ,'.tif'), overwrite=TRUE)
#rast_test <- raster::subs(cells_raster, landings, by = "Cell", which = "cell_catch", subsWithNA=TRUE)
#writeRaster(rast_test, filename = paste0(rastFolder, "artisanal", "_landings/annual_catch_", yr, ".tif"))
#plot(rast_test)
  raster::subs(cells_raster, discards, by = "Cell", which = "cell_catch", subsWithNA=TRUE, 
               filename = paste0(rastFolder, rast_prefx, '_discards/annual_catch_', yr ,'.tif'), overwrite=TRUE) 
  
  }
}
## Applies catch2raster function on commercial (industrial) then artisanal (non-industrial) files
create_rast <- map2(raw_suffx, rast_prefx, catch2raster)

#Error in { : task 1 failed - "non trovo la funzione "str_subset""
```

```{r}
#try to crop large raster with fao raster atl
regions_atl_FAO <- st_read("~/big/atl_regions/Regions_atl_FAO.shp", quiet = TRUE)
reg_atl_FAO_sp <- as(regions_atl_FAO, 'Spatial')
rast_crop_test<-crop(rast_test,reg_atl_FAO_sp)
rast_mask_test<-mask(rast_crop_test,reg_atl_FAO_sp)


cols = rev(colorRampPalette(brewer.pal(11, 'Spectral'))(255)) # rainbow color scheme
plot(rast_mask_test, col=cols)
```

